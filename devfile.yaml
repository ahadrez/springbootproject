schemaVersion: 2.2.2
metadata:
  name: java-maven
  displayName: Maven Java
  description: Java application based on Maven 3.8 and OpenJDK 21
  icon: https://raw.githubusercontent.com/devfile-samples/devfile-stack-icons/main/java-maven.jpg
  tags: [Java, Maven]
  projectType: Maven
  language: Java
  version: 1.3.1

components:
  - name: tools
    container:
      image: quay.io/upstream/ubi9:openjdk-21-custom
      command: ["tail", "-f", "/dev/null"]
      memoryLimit: 1Gi
      mountSources: true
      endpoints:
        - name: https-maven
          targetPort: 8080
          protocol: https
        - exposure: none
          name: debug
          targetPort: 5858
      volumeMounts:
        - name: m2
          path: /home/user/.m2
      env:
        - name: DEBUG_PORT
          value: "5858"
  - name: m2
    volume: {}

commands:
  # ðŸ§© Build the app (Maven) and container image (Buildah) in one step
  - id: package-and-build
    composite:
      commands:
        - mvn-package
        - build-image
      group:
        kind: build
        isDefault: true
      label: "Package + Build Image"

  - id: mvn-package
    exec:
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: mvn -Dmaven.repo.local=/home/user/.m2/repository package
      group:
        kind: build

  - id: build-image
    exec:
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: >
        bash -lc '
        export XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/tmp/${UID}};
        mkdir -p "$XDG_RUNTIME_DIR";
        buildah bud
          --storage-driver=vfs
          --userns=keep-id
          --format=docker
          -t java-maven-app:latest
          -f Dockerfile
          .'
      group:
        kind: build

  - id: run
    exec:
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: java -jar target/*.jar
      group:
        kind: run
        isDefault: true

  - id: debug
    exec:
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: java -Xdebug -Xrunjdwp:server=y,transport=dt_socket,address=${DEBUG_PORT},suspend=n -jar target/*.jar
      group:
        kind: debug
        isDefault: true

starterProjects:
  - name: springbootproject
    git:
      remotes:
        origin: https://github.com/ahadrez/springboot-ex.git
